<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="generator" content="Observable Framework v1.13.3">
<title>Bolivia 2025</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&amp;display=swap" crossorigin>
<link rel="preload" as="style" href="./_observablehq/theme-air,near-midnight,alt,wide.db1cdf55.css">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&amp;display=swap" crossorigin>
<link rel="stylesheet" type="text/css" href="./_observablehq/theme-air,near-midnight,alt,wide.db1cdf55.css">
<link rel="modulepreload" href="./_observablehq/client.0f853e96.js">
<link rel="modulepreload" href="./_observablehq/runtime.e080113b.js">
<link rel="modulepreload" href="./_observablehq/stdlib.24b62b2e.js">
<link rel="modulepreload" href="./_npm/maplibre-gl@5.6.2/80bead44.js">
<link rel="modulepreload" href="./_npm/pmtiles@4.3.0/5b853975.js">
<link rel="modulepreload" href="./_npm/d3@7.9.0/e780feca.js">
<link rel="modulepreload" href="./_npm/@observablehq/plot@0.6.17/d761ef9b.js">
<link rel="modulepreload" href="./_npm/fflate@0.8.2/e113a0e7.js">
<link rel="modulepreload" href="./_npm/d3-array@3.2.4/e93ca09f.js">
<link rel="modulepreload" href="./_npm/d3-axis@3.0.0/0f2de24d.js">
<link rel="modulepreload" href="./_npm/d3-brush@3.0.0/65eb105b.js">
<link rel="modulepreload" href="./_npm/d3-chord@3.0.1/7ef8fb2e.js">
<link rel="modulepreload" href="./_npm/d3-color@3.1.0/aeb57b94.js">
<link rel="modulepreload" href="./_npm/d3-contour@4.0.2/1d2aed74.js">
<link rel="modulepreload" href="./_npm/d3-delaunay@6.0.4/5ced1d52.js">
<link rel="modulepreload" href="./_npm/d3-dispatch@3.0.1/9ba9c7f3.js">
<link rel="modulepreload" href="./_npm/d3-drag@3.0.0/4202580c.js">
<link rel="modulepreload" href="./_npm/d3-dsv@3.0.1/9cffc2bd.js">
<link rel="modulepreload" href="./_npm/d3-ease@3.0.1/cdd7e898.js">
<link rel="modulepreload" href="./_npm/d3-fetch@3.0.1/b4e2ad9a.js">
<link rel="modulepreload" href="./_npm/d3-force@3.0.0/5e804d15.js">
<link rel="modulepreload" href="./_npm/d3-format@3.1.0/86074ef6.js">
<link rel="modulepreload" href="./_npm/d3-geo@3.1.1/40599fb3.js">
<link rel="modulepreload" href="./_npm/d3-hierarchy@3.1.2/e49e792c.js">
<link rel="modulepreload" href="./_npm/d3-interpolate@3.0.1/8d1e5425.js">
<link rel="modulepreload" href="./_npm/d3-path@3.1.0/20d3f133.js">
<link rel="modulepreload" href="./_npm/d3-polygon@3.0.1/7553081f.js">
<link rel="modulepreload" href="./_npm/d3-quadtree@3.0.1/0dfd751c.js">
<link rel="modulepreload" href="./_npm/d3-random@3.0.1/3c90ee06.js">
<link rel="modulepreload" href="./_npm/d3-scale@4.0.2/843b6a76.js">
<link rel="modulepreload" href="./_npm/d3-scale-chromatic@3.1.0/ba24c2e7.js">
<link rel="modulepreload" href="./_npm/d3-selection@3.0.0/4d94e5b7.js">
<link rel="modulepreload" href="./_npm/d3-shape@3.2.0/6d3a6726.js">
<link rel="modulepreload" href="./_npm/d3-time@3.1.0/9f03c579.js">
<link rel="modulepreload" href="./_npm/d3-time-format@4.1.0/07c9626f.js">
<link rel="modulepreload" href="./_npm/d3-timer@3.0.1/b58a267d.js">
<link rel="modulepreload" href="./_npm/d3-transition@3.0.1/004da2ac.js">
<link rel="modulepreload" href="./_npm/d3-zoom@3.0.0/b5786b3f.js">
<link rel="modulepreload" href="./_npm/isoformat@0.2.1/18cbf477.js">
<link rel="modulepreload" href="./_npm/interval-tree-1d@1.0.4/53fe8176.js">
<link rel="modulepreload" href="./_npm/internmap@2.0.3/e08981d9.js">
<link rel="modulepreload" href="./_npm/delaunator@5.0.1/02d43215.js">
<link rel="modulepreload" href="./_npm/binary-search-bounds@2.0.5/cbf6ba23.js">
<link rel="modulepreload" href="./_npm/robust-predicates@3.0.2/aa00730b.js">
<link rel="icon" href="https://mauforonda.github.io/images/icon.svg" type="image/svg" sizes="32x32">
<script type="module">

import {define} from "./_observablehq/client.0f853e96.js";
import {registerFile} from "./_observablehq/stdlib.24b62b2e.js";

registerFile("./imagenes/ap.webp", {"name":"./imagenes/ap.webp","mimeType":"image/webp","path":"./_file/imagenes/ap.8f26d418.webp","lastModified":1755644610602,"size":18424});
registerFile("./imagenes/apb-sumate.webp", {"name":"./imagenes/apb-sumate.webp","mimeType":"image/webp","path":"./_file/imagenes/apb-sumate.6be31528.webp","lastModified":1755644610602,"size":48160});
registerFile("./imagenes/fp.webp", {"name":"./imagenes/fp.webp","mimeType":"image/webp","path":"./_file/imagenes/fp.7f1aa632.webp","lastModified":1755644610602,"size":10220});
registerFile("./imagenes/libre.webp", {"name":"./imagenes/libre.webp","mimeType":"image/webp","path":"./_file/imagenes/libre.f3b956c2.webp","lastModified":1755644610602,"size":14496});
registerFile("./imagenes/lyp-adn.webp", {"name":"./imagenes/lyp-adn.webp","mimeType":"image/webp","path":"./_file/imagenes/lyp-adn.19b6d52b.webp","lastModified":1755644610603,"size":295964});
registerFile("./imagenes/mas-ipsp.webp", {"name":"./imagenes/mas-ipsp.webp","mimeType":"image/webp","path":"./_file/imagenes/mas-ipsp.337a492c.webp","lastModified":1755644610604,"size":38746});
registerFile("./imagenes/pdc.webp", {"name":"./imagenes/pdc.webp","mimeType":"image/webp","path":"./_file/imagenes/pdc.ffe97178.webp","lastModified":1755644610604,"size":47182});
registerFile("./imagenes/unidad.webp", {"name":"./imagenes/unidad.webp","mimeType":"image/webp","path":"./_file/imagenes/unidad.2fd99556.webp","lastModified":1755644610604,"size":44812});

define({id: "59519bf1", mode: "inline", inputs: ["timestamp_string","display"], body: async (timestamp_string,display) => {
display(await(
timestamp_string
))
}});

define({id: "701bc5b3", mode: "inline", inputs: ["d3","progreso","display"], body: async (d3,progreso,display) => {
display(await(
d3.format(".2%")(progreso)
))
}});

define({id: "367a1f0d", outputs: ["maplibregl","PMTiles","Protocol"], body: async () => {
const [{default: maplibregl}, {PMTiles, Protocol}] = await Promise.all([import("./_npm/maplibre-gl@5.6.2/80bead44.js"), import("./_npm/pmtiles@4.3.0/5b853975.js")]);

return {maplibregl,PMTiles,Protocol};
}});

define({id: "a9ffa112", inputs: ["Protocol","maplibregl"], outputs: ["protocol"], body: (Protocol,maplibregl) => {
const protocol = new Protocol();
maplibregl.addProtocol("pmtiles", protocol.tile);
return {protocol};
}});

define({id: "9c5d30a5", inputs: ["d3","FileAttachment"], outputs: ["gh","recintos","resultados","timestamp","dateFormatter","timestamp_string","progreso","fotos","colores","fondo"], body: async (d3,FileAttachment) => {
const gh =
  "https://raw.githubusercontent.com/datosbolivia/elecciones2025/refs/heads/main/resultados/datos/";
const recintos = await d3.json(`${gh}recintos.geojson`);
const resultados = await d3.json(`${gh}resultados.json`);
const timestamp = await fetch(`${gh}timestamp`).then((r) => r.text());
const dateFormatter = new Intl.DateTimeFormat("es", {
  year: "numeric",
  month: "long",
  day: "numeric",
  hour: "numeric",
  minute: "numeric",
  timeZone: "UTC",
});
const timestamp_string = dateFormatter.format(new Date(timestamp));
const progreso = await fetch(`${gh}progreso`).then((r) => r.text());
let fotos = {
  AP: await FileAttachment("./imagenes/ap.webp").url(),
  "LYP-ADN": await FileAttachment("./imagenes/lyp-adn.webp").url(),
  "APB-SUMATE": await FileAttachment("./imagenes/apb-sumate.webp").url(),
  LIBRE: await FileAttachment("./imagenes/libre.webp").url(),
  FP: await FileAttachment("./imagenes/fp.webp").url(),
  "MAS-IPSP": await FileAttachment("./imagenes/mas-ipsp.webp").url(),
  UNIDAD: await FileAttachment("./imagenes/unidad.webp").url(),
  PDC: await FileAttachment("./imagenes/pdc.webp").url(),
};
let colores = {
  AP: ["#00b5ee", "#4f7d35"],
  "LYP-ADN": ["#a91521", "#2f2f30"],
  "APB-SUMATE": ["#430956", "#cb010d"],
  LIBRE: ["#f50303", "#1d65c5"],
  FP: ["#1897d5", "#59c4f0"],
  "MAS-IPSP": ["#143a83", "#585755"],
  UNIDAD: ["#feb447", "#083c6b"],
  PDC: ["#05636b", "#dd0710"],
};
let fondo = {
  gris: "#ccc",
  texto: "#a0a0a0ff",
};
return {gh,recintos,resultados,timestamp,dateFormatter,timestamp_string,progreso,fotos,colores,fondo};
}});

define({id: "076f91d7", inputs: ["recintos","resultados","colores","fondo"], outputs: ["colores_expresion"], body: (recintos,resultados,colores,fondo) => {
// consolidar resultados y recintos

for (const feature of recintos.features) {
  const codigo = feature.properties.c;
  const resultado = resultados[codigo];
  feature.properties.partido = resultado?.g ?? null;
}

let colores_expresion = ["match", ["get", "partido"]];
for (const [opcion, color] of Object.entries(colores))
  colores_expresion.push(opcion, color[0]);
colores_expresion.push(fondo.gris);
return {colores_expresion};
}});

define({id: "4d744dd8", outputs: ["labels","recintos_hover"], body: () => {
const labels = {
  source: {
    type: "raster",
    tiles: [
      "https://a.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png",
    ],
    tileSize: 256,
  },
  layer: {
    id: "labels-layer",
    type: "raster",
    source: "labels",
    paint: {
      "raster-opacity": 0.8,
    },
  },
};

const recintos_hover = {
  id: "recintos_hover",
  type: "circle",
  source: "recintos",
  filter: ["!=", ["get", "partido"], null],
  paint: {
    "circle-color": "rgba(0,0,0,0)",
    "circle-radius": [
      "interpolate",
      ["exponential", 1.2],
      ["zoom"],
      6,
      10,
      10,
      14,
      12,
      18,
      14,
      22,
      16,
      26,
      18,
      30,
    ],
  },
};
return {labels,recintos_hover};
}});

define({id: "842c8555", inputs: ["Plot","fotos","fondo","colores","d3"], outputs: ["plot_resultado"], body: (Plot,fotos,fondo,colores,d3) => {
function plot_resultado(resultado) {
  if (resultado) {
    const r = Object.entries(resultado.r);
    const total = r.reduce((s, [, v]) => s + v, 0);
    const data = r
      .map(([opcion, conteo]) => ({
        opcion,
        conteo,
        porcentaje: conteo / total,
      }))
      .sort((a, b) => b.conteo - a.conteo);

    return Plot.plot({
      margin: 0,
      marginLeft: 80,
      marginRight: 10,
      height: data.length * 90,
      x: { axis: null, domain: [0, 1] },
      y: { axis: null, domain: data.map((d) => d.opcion) },
      marks: [
        Plot.image(data, {
          x: 0,
          y: "opcion",
          src: (d) => fotos[d.opcion],
          dx: -50,
          dy: 10,
          r: 28,
          width: 80,
        }),
        Plot.barX(data, {
          x: 1,
          y: "opcion",
          fill: fondo.gris,
          fillOpacity: 0.3,
          insetTop: 40,
          insetBottom: 10,
          r: 15,
        }),
        Plot.barX(data, {
          x: "porcentaje",
          y: "opcion",
          fill: (d) => colores[d.opcion][0],
          fillOpacity: 0.5,
          insetTop: 40,
          insetBottom: 10,
          r: 15,
        }),
        Plot.barX(data, {
          x: 1,
          y: "opcion",
          fill: null,
          stroke: fondo.texto,
          strokeOpacity: 0.5,
          strokeWidth: 1,
          insetTop: 40,
          insetBottom: 10,
          r: 15,
        }),
        Plot.text(data, {
          x: 1,
          y: "opcion",
          text: (d) => d3.format(".1%")(d.porcentaje),
          fill: fondo.texto,
          fontSize: 35,
          lineAnchor: "bottom",
          textAnchor: "end",
          dy: -15,
          dx: -5,
          fontFamily: "Inter",
        }),
        Plot.text(data, {
          x: 0,
          y: "opcion",
          text: (d) => `${d.conteo} votos`,
          fill: fondo.texto,
          fillOpacity: 0.8,
          fontSize: 30,
          lineAnchor: "bottom",
          textAnchor: "start",
          dy: -15,
          dx: 5,
          fontFamily: "Inter",
        }),
      ],
    });
  } else {
    return "";
  }
}
return {plot_resultado};
}});

define({id: "e70465fd", inputs: ["display","maplibregl","recintos","colores_expresion","labels","recintos_hover","resultados","plot_resultado","invalidation"], outputs: ["div","map","popup","locked","mouseenter","mouseleave"], body: (display,maplibregl,recintos,colores_expresion,labels,recintos_hover,resultados,plot_resultado,invalidation) => {
const div = display(document.createElement("div"));
div.id = "mapa";
const map = new maplibregl.Map({
  container: div,
  center: [-65.482, -17.237],
  zoom: 5,
  style:
    "https://basemaps.cartocdn.com/gl/positron-nolabels-gl-style/style.json",
  scrollZoom: true,
  attributionControl: {
    compact: true,
    customAttribution:
      "<a href='https://mauforonda.github.io/'>Mauricio Foronda</a>",
  },
});

map.on("load", function () {
  map.addSource("recintos", {
    type: "geojson",
    data: recintos,
  });

  map.addLayer({
    id: "recintos",
    type: "circle",
    source: "recintos",
    paint: {
      "circle-radius": [
        "interpolate",
        ["exponential", 1.4],
        ["zoom"],
        6,
        2,
        10,
        4,
        12,
        6,
        14,
        9,
        16,
        12,
        18,
        16,
      ],
      "circle-color": colores_expresion,
      "circle-opacity": 0.5,
    },
  });

  map.addSource("labels", labels.source);
  map.addLayer(labels.layer);

  map.addLayer(recintos_hover);
});

const popup = new maplibregl.Popup({
  closeButton: false,
  closeOnClick: false,
});

let locked = false;

const mouseenter = function (e) {
  map.getCanvas().style.cursor = "pointer";
  const recinto_feature = e.features[0];
  const resultado = resultados[recinto_feature.properties.c] ?? null;
  const grafico = plot_resultado(resultado);
  popup
    .setHTML(
      `<div class="popup_plot">
    <div class="popup_header">${resultado ? resultado.n : ""}</div>
    ${grafico.outerHTML}
    </div>`
    )
    .setLngLat(recinto_feature.geometry.coordinates)
    .addTo(map);
};

const mouseleave = function () {
  map.getCanvas().style.cursor = "";
  if (!locked) popup.remove();
};

map.on("mouseenter", "recintos_hover", mouseenter);
map.on("mouseleave", "recintos_hover", mouseleave);

map.on("click", "recintos_hover", () => {
  locked = true;
});

map.on("click", (e) => {
  if (
    !map.queryRenderedFeatures(e.point, { layers: ["recintos_hover"] }).length
  ) {
    locked = false;
    popup.remove();
  }
});

map.addControl(new maplibregl.NavigationControl());
map.addControl(
  new maplibregl.GeolocateControl({
    positionOptions: {
      enableHighAccuracy: true,
    },
    showAccuracyCircle: false,
    showUserLocation: true,
  }),
  "top-right"
);

invalidation.then(() => map.remove());
return {div,map,popup,locked,mouseenter,mouseleave};
}});

</script>
</head>
<body>
<div id="observablehq-center">
<main id="observablehq-main" class="observablehq">
<link rel="stylesheet" type="text/css" href="https://unpkg.com/maplibre-gl@4.0.2/dist/maplibre-gl.css">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap');
  #observablehq-main, #observablehq-center {
    margin: 0;
    min-height: 100vh;
  }
  .header {
    color: black;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: sticky;
    z-index:4;
    background: white;
    top: 0;
    left: 0;
    height: 100px;
    background: #fff;
    .title {
      font-family: serif;
      font-size: 1.5rem;
      font-weight: 600;
    }
    .subtitle {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 3px;
      font-family: "Inter", sans-serif;
      font-weight: 600;
      font-size: .8em;
      .timestamp {
        font-weight: 400;
        opacity: .4;
        font-family: mono;
        font-size: .7rem;
      }
    }
  }
  #mapa {
    position: absolute; 
    top: 100px; 
    bottom: 0; 
    width: 100%;
  }
  .maplibregl-popup {
      max-width: 400px;
      font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
  }
  .popup_header {
    font-family: "Inter";
    text-align: center;
    opacity: .3;
    font-size: .9em;
    text-transform: uppercase;
    margin-bottom: 10px;
  }
</style>
<div class="header">
  <div class="title">Bolivia 2025</div>
  <div class="subtitle"><span>Votos para presidente dentro del país</span><span class="timestamp">actualizado el <observablehq-loading></observablehq-loading><!--:59519bf1:--> y contado al <observablehq-loading></observablehq-loading><!--:701bc5b3:--></span></div>
</div>
<div class="observablehq observablehq--block"><!--:367a1f0d:--></div>
<div class="observablehq observablehq--block"><!--:a9ffa112:--></div>
<div class="observablehq observablehq--block"><!--:9c5d30a5:--></div>
<div class="observablehq observablehq--block"><!--:076f91d7:--></div>
<div class="observablehq observablehq--block"><!--:4d744dd8:--></div>
<div class="observablehq observablehq--block"><!--:842c8555:--></div>
<div class="observablehq observablehq--block"><!--:e70465fd:--></div>
</main>
</div>
</body>
</html>
